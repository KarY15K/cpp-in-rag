# 01.用户认证和鉴权（jwt）

# 01.用户认证和鉴权（jwt）


JWT认证



1.前后端token的认证流程：



前端发送登陆请求 – > 后端登陆接口接受 -->后端数据处理后返给前端token –> 前端将token存储后 -->每次请求都带着这个token去访问 —>后端设置jwtoken拦截器 -->只放行登陆接口 -->如果前端访问别的接口必须带有token –> 否则被拦截器拦截 并让前端回复到登陆页面



2、Token的处理方式：



JWT的token当服务端返回以后，是需要客户端进行主动地动作的，并不是像cookie一样，在后边的请求，都会自动带过去。这样就导致了如下几种做法：



将Jwt的token作为cookie返回给客户端。这样后续的请求都会带着这个token过来。这样在拦截的时候，就可以使用了。



将Jwt的token作为返回字符串，先返回给前端，前端再后续请求时，写到anthorization的request的head中，这个做法需要 编程去做，而且通用的做法，都是在ajax当中去做。构造请求。



将Jwt的token作为返回字符串，先返回给前端，前端再后续请求时，将Jwt的token写到token的request的head中，这个做法，也是编程实现，只不过具体做法，也是通过ajax进行。构造请求。只不过是自定义的head。



其实jwt的token也可以作为URL的参数进行传递的，这也是一个方法。



另外，jwt返回给前端的token，一般的做法都是放到localStorage当中，也就是前端浏览器的存储空间当中。可以将token存储在 localstorage里面,需要防止xss攻击



3、例子：



在登陆请求成功后把后端返回数据存储到浏览器



定义request.js 统一处理发送的请求为其加上token ，统一处理响应 若包含统一返回类code为 token未验证成功code 401 则让用户到登陆页面重新登陆



注意：客户端必须主动操作jwt返回的token，这个就不是自动的过程了。



2.JWT的使用建议  
通常来说，一共由三种使用的方案：



JWT的方案  
1、用户去认证中心登录，认证中心生成JWT，返回给客户端。



2、客户端带着jwt，请求其他的多个系统。



3、其他的系统，自己解析jwt，如果能解析，就说明登录成功，就可以继续业务。



通常，这个方案会将用户名等信息放到jwt当中，这样就不用认证中心校验了。



JWT + 认证中心 + redis  
1、用户去认证中心登录，认证中心生产JWT，然后保存到reids中，然后再发给客户端



2、客户端带着jwt，去访问其他的多个系统。



3、其他收系统，取出jwt，传给认证中心。认证中心解析jwt，并将解析结果与redis的结果对比，然后将具体的用户信息返回给客户端。



JWT+认证中心+redis+各个系统redis  
1、用户去认证中心登录，认证中心生产JWT，然后保存到reids中，然后再发给客户端



2、客户端带着jwt，去访问其他的多个系统。



3、多系统(比如系统A)收到jwt，A解析并取出用户信息，先判断自己的A的redis中有没有jwt。 3.1 如果有，就合法，a系统可以继续执行业务逻辑。 3.2 如果没有就拿着jwt去认证中心验证。 3.2.1 如果通过，a系统就把这个jwt保存到自己的redis，并设置对应的失效时间。 下次这个jwt再来到a的时候，就不需要去认证中心校验了。 3.2.2 如果验证不通过此次请求就不合法，告诉客户端需要跳转登录页面， 去认证中心登录，返回步骤1。



很多人都建议在使用token以后，就不用在后端存储用户信息了，其实理论上是可以的，但是JWT也是有安全问题的，所以一般是不建议这么用的。



建议做法：用户登录校验成功后会随机生成一个key，比如uuid，使用这个随机生成的key作为key，用户信息作为value，保存在Redis中，并设置失效时间。然后创建一个JWT TOKEN，使用随机生成的key作为jwt的有效载体，将生成好的JWT Token返给前端，前端保存在本地，当访问后端服务时，前端需要在请求头中携带 jwt token，后端通过拦截器对请求进行拦截，校验token是否有效，如果token有效，则在jwt token的有效载体中获取key，然后使用该key在redis中查找是否存在，如果存在说明登录验证通过，如果不存在说明验证登录信息已过期。



封装了一个JWT工具类提供创建JWT Token和解析JWT Token的方法，登录接口，根据用户提交的登录信息，校验通过后生成JWT Token，客户端保存token，以后访问服务时需要在请求头中携带token。Token校验接口，在拦截器中进行处理，应用程序访问服务时在拦截器校验Header中携带token的有效性，如果有效则返回请求的服务资源，如果无效则返回认证失败。



> 更新: 2024-04-19 15:34:55  
> 原文: <https://www.yuque.com/linuxer/gscfv1/b6ede275e3a89e4576ce997887a561c4>