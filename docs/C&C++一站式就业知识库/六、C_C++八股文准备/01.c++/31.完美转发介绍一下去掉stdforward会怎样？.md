# 31.完美转发介绍一下 去掉stdforward会怎样？

# 31.完美转发介绍一下 去掉std::forward会怎样？


完美转发是一种 C++ 技术，用于在函数模板中精确地将参数传递到另一个函数，同时保留原始参数的类型信息和左右值属性。它是通过使用通用引用（也称为万能引用）和 std::forward 函数来实现的。



通常情况下，在编写函数模板时，我们需要将传递给函数的参数传递给另一个函数。例如：



```plain
template<typename T>
void foo(T arg) {
    bar(arg);
}
```



在上面的代码中，我们定义了一个函数模板 foo，其中的参数 arg 是一个模板参数类型，它会被传递给另一个函数 bar，但是这样会丢失一些信息，例如参数的左右值属性、是否为 const 或 volatile 限定符等等。



为了避免这种情况，可以使用通用引用和 std::forward 函数来实现完美转发。例如：



```plain
template<typename T>
void foo(T&& arg) {
    bar(std::forward<T>(arg));
}
```



在上面的代码中，我们使用 T&& 声明了一个通用引用类型的参数 arg，然后利用 std::forward 函数将 arg 转发给另一个函数 bar。std::forward 函数会根据参数的左右值属性和类型信息，正确地将参数转发给目标函数，并保留原始参数的所有属性。



完美转发是一种 C++ 技术，可以在函数模板中精确地传递参数，同时保留原始参数的类型信息和左右值属性。它是通过使用通用引用和 std::forward 函数来实现的。掌握它的用法可以提高代码的可读性和效率。



**std::forward()函数的使用**



std::forward 是一个 C++11 中的库函数，用于实现完美转发。它可以将给定的参数转发到另一个函数中去，并保留原始参数的类型信息和左右值属性。



std::forward 主要用于处理通用引用类型（即使用 && 或 template T&& 声明的类型），这些类型可能是左值引用或右值引用，也可能是 const 或 volatile 限定符。通过使用 std::forward，我们可以将这些通用引用类型的参数精确地传递到目标函数中去，避免不必要的拷贝操作。



以下是 std::forward 的语法：



```plain
template <typename T>
T&& forward(typename std::remove_reference<T>::type& arg) noexcept;

template <typename T>
T&& forward(typename std::remove_reference<T>::type&& arg) noexcept;
```



示例代码如下：



```plain
#include <iostream>
#include <utility>

void print(const std::string& str) {
    std::cout << "Lvalue: " << str << std::endl;
}

void print(std::string&& str) {
    std::cout << "Rvalue: " << str << std::endl;
}

template<typename T>
void foo(T&& arg) {
    print(std::forward<T>(arg));
}

int main() {
    std::string s = "Hello, world!";
    foo(s); // Lvalue: Hello, world!
    foo(std::move(s)); // Rvalue: Hello, world!
    return 0;
}
```



在上面的示例代码中，我们定义了两个函数 print，一个接受左值引用类型的参数，另一个接受右值引用类型的参数。然后，我们定义了一个模板函数 foo，其中的参数 arg 是一个通用引用类型，可以同时接受左值引用和右值引用。



在 foo 函数中，我们使用 std::forward 函数将 arg 转发给 print 函数，并保留原始参数的类型信息和左右值属性。当我们传递一个左值时，arg 的类型被推导为 std::string& 类型，然后使用 std::forwardstd::string& 将参数转发给 print(const std::string&) 函数。而当我们传递一个右值时，arg 的类型被推导为 std::string&& 类型，然后使用 std::forwardstd::string&& 将参数转发给 print(std::string&&) 函数。



总之，在 C++ 中，std::forward 函数的作用是实现完美转发，它可以将通用引用类型的参数精确地传递到目标函数中去，并保留原始参数的类型信息和左右值属性。



> 更新: 2024-04-19 15:30:32  
> 原文: <https://www.yuque.com/linuxer/gscfv1/97805d719f73c8a94ef21de08eb34920>